<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Detection với MediaPipe</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- MediaPipe Face Landmarker -->
    <!-- <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script> -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style cho canvas vẽ đè lên video */
        .overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Style cho nút bị vô hiệu hóa */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <div class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Xác thực khuôn mặt</h1>
            <p class="text-gray-500 mb-6">Vui lòng nhìn thẳng vào camera và nhấn "Chụp & Xác thực" khi nút sáng lên.</p>
        </div>

        <!-- Vùng hiển thị Camera và Canvas -->
        <div class="relative aspect-video bg-gray-900 rounded-lg overflow-hidden mb-6 shadow-inner">
            <video id="webcam" class="w-full h-full object-cover" autoplay playsinline></video>
            <canvas id="overlay" class="overlay-canvas"></canvas>
            <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white">
                <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-3">Đang tải model...</span>
            </div>
        </div>
        
        <!-- Vùng hiển thị ảnh đã chụp -->
        <div id="snapshot-container" class="text-center hidden">
             <h2 class="text-xl font-semibold text-green-600 mb-4">Xác thực thành công!</h2>
             <img id="snapshot" class="rounded-lg shadow-md mx-auto" alt="Ảnh đã chụp"/>
        </div>


        <!-- Nút điều khiển và thông báo -->
        <div class="flex flex-col items-center space-y-4">
            <div id="controls" class="flex items-center space-x-4">
                 <button id="openCameraButton" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 ease-in-out">
                    Mở Camera
                </button>
                <button id="submitButton" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 ease-in-out" disabled>
                    Chụp & Xác thực
                </button>
            </div>
            <p id="statusMessage" class="text-gray-600 h-6 text-center"></p>
        </div>
    </div>

    <script type="module">
        // --- BƯỚC 1: KHỞI TẠO CÁC BIẾN VÀ LẤY CÁC PHẦN TỬ HTML ---

        const { FaceLandmarker, FilesetResolver } = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3");

        const video = document.getElementById("webcam");
        const canvas = document.getElementById("overlay");
        const ctx = canvas.getContext("2d");
        const openCameraButton = document.getElementById("openCameraButton");
        const submitButton = document.getElementById("submitButton");
        const statusMessage = document.getElementById("statusMessage");
        const loadingSpinner = document.getElementById("loading-spinner");
        const snapshotImg = document.getElementById("snapshot");
        const snapshotContainer = document.getElementById("snapshot-container");
        const controls = document.getElementById("controls");

        let faceLandmarker;
        let lastValidResult = null; // Lưu trữ kết quả hợp lệ cuối cùng
        const CONFIDENCE_THRESHOLD = 0.5; // Ngưỡng độ tin cậy để coi là hợp lệ

        // --- BƯỚC 2: KHỞI TẠO MODEL MEDIAPIPE FACE LANDMARKER ---

        async function createFaceLandmarker() {
            statusMessage.textContent = "Đang tải model AI, vui lòng chờ...";
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                    // delegate: "GPU"
                },
                outputFaceBlendshapes: false, // Không cần dữ liệu biểu cảm
                outputFacialTransformationMatrixes: false,
                runningMode: "VIDEO",
                numFaces: 1 // Chỉ xử lý 1 khuôn mặt để tối ưu hiệu năng
            });
            loadingSpinner.classList.add("hidden");
            statusMessage.textContent = "Model đã sẵn sàng. Hãy mở camera.";
        }
        
        createFaceLandmarker();

        // --- BƯỚC 3: XỬ LÝ SỰ KIỆN VÀ VÒNG LẶP PHÁT HIỆN ---

        openCameraButton.addEventListener("click", enableCam);

        async function enableCam() {
            if (!faceLandmarker) {
                statusMessage.textContent = "Model chưa sẵn sàng, vui lòng chờ.";
                return;
            }

            snapshotContainer.classList.add("hidden");
            video.parentElement.classList.remove("hidden");
            controls.classList.remove("hidden");

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                openCameraButton.textContent = "Đóng Camera";
                openCameraButton.removeEventListener("click", enableCam);
                openCameraButton.addEventListener("click", disableCam);
            } catch (err) {
                console.error(err);
                statusMessage.textContent = "Không thể truy cập camera.";
            }
        }

        function disableCam() {
             const stream = video.srcObject;
             if (stream) {
                stream.getTracks().forEach(track => track.stop());
             }
             video.srcObject = null;
             ctx.clearRect(0, 0, canvas.width, canvas.height);
             submitButton.disabled = true;
             statusMessage.textContent = "";
             openCameraButton.textContent = "Mở Camera";
             openCameraButton.removeEventListener("click", disableCam);
             openCameraButton.addEventListener("click", enableCam);
        }

        let lastVideoTime = -1;
        async function predictWebcam() {
            if (canvas.width !== video.videoWidth) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                const results = faceLandmarker.detectForVideo(video, performance.now());
                displayResults(results);
            }

            if (video.srcObject) {
                window.requestAnimationFrame(predictWebcam);
            }
        }

        function displayResults(results) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            lastValidResult = null;

            // console.log(results.f)

            if (results.faceLandmarks.length >=400) {
                const landmarks = results.faceLandmarks[0];
                // const detection = results.faceDetections[0];
                // const confidence = detection.categories[0].score;

                // Vẽ bounding box dựa trên các landmark
                // drawBoundingBoxFromLandmarks(landmarks, confidence);

                // if (confidence > CONFIDENCE_THRESHOLD) {
                //     statusMessage.textContent = "Khuôn mặt hợp lệ! Sẵn sàng để chụp.";
                //     submitButton.disabled = false;
                //     lastValidResult = results;
                // } else {
                //     statusMessage.textContent = "Độ tin cậy thấp, vui lòng thử lại.";
                //     submitButton.disabled = true;
                // }
            } else {
                statusMessage.textContent = "Đang tìm khuôn mặt...";
                submitButton.disabled = true;
            }
        }

        function drawBoundingBoxFromLandmarks(landmarks, confidence) {
            // Tính toán bounding box từ các điểm landmark
            let minX = 1.0, minY = 1.0, maxX = 0.0, maxY = 0.0;
            for (const landmark of landmarks) {
                minX = Math.min(minX, landmark.x);
                minY = Math.min(minY, landmark.y);
                maxX = Math.max(maxX, landmark.x);
                maxY = Math.max(maxY, landmark.y);
            }

            // Chuyển đổi tọa độ tương đối sang tọa độ tuyệt đối trên canvas
            const originX = minX * canvas.width;
            const originY = minY * canvas.height;
            const width = (maxX - minX) * canvas.width;
            const height = (maxY - minY) * canvas.height;

            // Vẽ bounding box
            ctx.strokeStyle = "#34d399"; // Màu xanh lá
            ctx.lineWidth = 4;
            ctx.strokeRect(originX, originY, width, height);

            // Vẽ background cho text confidence
            ctx.fillStyle = "#34d399";
            const text = `Confidence: ${Math.round(confidence * 100)}%`;
            const textWidth = ctx.measureText(text).width;
            ctx.fillRect(originX - 2, originY - 25, textWidth + 10, 22);
            
            // Vẽ text confidence
            ctx.fillStyle = "#ffffff";
            ctx.font = "16px Inter";
            ctx.fillText(text, originX + 3, originY - 8);
        }

        // --- BƯỚC 4: XỬ LÝ SUBMIT ---

        submitButton.addEventListener("click", handleSubmit);

        function handleSubmit() {
            if (!lastValidResult) {
                statusMessage.textContent = "Lỗi: Không có khuôn mặt hợp lệ để chụp.";
                return;
            }

            const snapshotCanvas = document.createElement("canvas");
            snapshotCanvas.width = video.videoWidth;
            snapshotCanvas.height = video.videoHeight;
            const snapshotCtx = snapshotCanvas.getContext("2d");
            snapshotCtx.drawImage(video, 0, 0, snapshotCanvas.width, snapshotCanvas.height);
            
            snapshotImg.src = snapshotCanvas.toDataURL("image/png");
            snapshotContainer.classList.remove("hidden");

            video.parentElement.classList.add("hidden");
            controls.classList.add("hidden");
            statusMessage.textContent = "";

            disableCam();
        }
    </script>
</body>
</html>